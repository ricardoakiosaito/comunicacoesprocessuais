<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>utilitario</title>
    <style>
        body{
            text-align: center;
            margin: 5%;
        }

        main, head{
            text-align: left;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
</head>
<body>
    <head>
       
        <select id="trib">

        <option value="TRF1">TRF1</option>
        <option value="TRF2">TRF2</option>
        <option value="TRF3">TRF3</option>
        <option value="TRF4">TRF4</option>
        <option value="TRF5">TRF5</option>
        <option value="TRF6">TRF6</option>
        <option value="TRT1">TRT1</option>
        <option value="TRT2">TRT2</option>
        <option value="TRT3">TRT3</option>
        <option value="TRT4">TRT4</option>
        <option value="TRT5">TRT5</option>
        <option value="TRT6">TRT6</option>
        <option value="TRT7">TRT7</option>
        <option value="TRT8">TRT8</option>
        <option value="TRT9">TRT9</option>
        <option value="TRT10">TRT10</option>
        <option value="TRT11">TRT11</option>
        <option value="TRT12">TRT12</option>
        <option value="TRT13">TRT13</option>
        <option value="TRT14">TRT14</option>
        <option value="TRT15">TRT15</option>
        <option value="TRT16">TRT16</option>
        <option value="TRT17">TRT17</option>
        <option value="TRT18">TRT18</option>
        <option value="TRT19">TRT19</option>
        <option value="TRT20">TRT20</option>
        <option value="TRT21">TRT21</option>
        <option value="TRT22">TRT22</option>
        <option value="TRT23">TRT23</option>

            

            <option value="">=======</option>
<option value="PJeCor">PJeCor</option>
<option value="CNJ">CNJ</option>
<option value="SEEU">SEEU</option>
<option value="CJF">CJF</option>
<option value="CSJT">CSJT</option>
<option value="STF">STF</option>
<option value="STJ">STJ</option>
<option value="STM">STM</option>
<option value="TJAC">TJAC</option>
<option value="TJAM">TJAM</option>
<option value="TJAP">TJAP</option>
<option value="TJBA">TJBA</option>
<option value="TJCE">TJCE</option>
<option value="TJDFT">TJDFT</option>
<option value="TJES">TJES</option>
<option value="TJGO">TJGO</option>
<option value="TJMA">TJMA</option>
<option value="TJMG">TJMG</option>
<option value="TMMG">TMMG</option>
<option value="TJMRS">TJMRS</option>
<option value="TMS">TMS</option>
<option value="TJMSP">TJMSP</option>
<option value="TJMT">TJMT</option>
<option value="TJMS">TJMS</option>            
<option value="TJPA">TJPA</option>
<option value="TJPB">TJPB</option>
<option value="TJPE">TJPE</option>
<option value="TJPI">TJPI</option>
<option value="TJPR">TJPR</option>
<option value="TJRJ">TJRJ</option>
<option value="TJRN">TJRN</option>
<option value="TJRO">TJRO</option>
<option value="TJRR">TJRR</option>
<option value="TJRS">TJRS</option>
<option value="TJSC">TJSC</option>
<option value="TJSE">TJSE</option>
<option value="TJSP">TJSP</option>
<option value="TJTO">TJTO</option>
<option value="TRE">TRE</option>
<option value="TRF">TRF</option>
<option value="TRT">TRT</option>
<option value="TSE">TSE</option>
<option value="TST">TST</option>
<option value="TRE-AC">TRE-AC</option>
<option value="TRE-AL">TRE-AL</option>
<option value="TRE-AM">TRE-AM</option>
<option value="TRE-AP">TRE-AP</option>
<option value="TRE-BA">TRE-BA</option>
<option value="TRE-CE">TRE-CE</option>
<option value="TRE-DF">TRE-DF</option>
<option value="TRE-ES">TRE-ES</option>
<option value="TRE-GO">TRE-GO</option>
<option value="TRE-MA">TRE-MA</option>
<option value="TRE-MG">TRE-MG</option>
<option value="TRE-MS">TRE-MS</option>
<option value="TRE-MT">TRE-MT</option>
<option value="TRE-PA">TRE-PA</option>
<option value="TRE-PB">TRE-PB</option>
<option value="TRE-PE">TRE-PE</option>
<option value="TRE-PI">TRE-PI</option>
<option value="TRE-PR">TRE-PR</option>
<option value="TRE-RJ">TRE-RJ</option>
<option value="TRE-RN">TRE-RN</option>
<option value="TRE-RO">TRE-RO</option>
<option value="TRE-RR">TRE-RR</option>
<option value="TRE-RS">TRE-RS</option>
<option value="TRE-SC">TRE-SC</option>
<option value="TRE-SE">TRE-SE</option>
<option value="TRE-SP">TRE-SP</option>
<option value="TRE-TO">TRE-TO</option>

        </select>
        <input type="text" id="dat" placeholder="Data"/>
        <input type="number" id="pag" placeholder="Número da página"/>
        <button id="btn" onclick="buscarDados()"> Buscar</button> 
        <button id="btn2" onclick="gerarPDF()"> Gerar PDF</button> 
    </head>

    <main id="conteudo">

    </main>

    <!-- Importando o JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    
    <script>


        //Pegando os itens do HTML para serem usados no código
        let tribunais = document.getElementById("trib");
        let data = document.getElementById("dat");
        let pagina = document.getElementById("pag");
        let conteudo = document.getElementById("conteudo");

        //Função chamada ao clicar o botão
        function buscarDados(){

            conteudo.innerHTML = "";//Limpando página antes da busca
            let tribunal= tribunais.options[tribunais.selectedIndex].text //pegando tribunal escolhido


            //Montando URL
            const url = `https://comunicaapi.pje.jus.br/api/v1/comunicacao?pagina=${pagina.value}&itensPorPagina=100&siglaTribunal=${tribunal}&dataDisponibilizacaoInicio=${data.value}&dataDisponibilizacaoFim=${data.value}`;
            
            //faz um GET na URL de forma assíncrona
            $.get(url, function(dados_json){

                console.log(dados_json);

                //Adiciona cada item do json a página
                dados_json.items.forEach( json =>{

                    formatarHTML(   
                                    json.siglaTribunal,
                                    pagina.value, 
                                    json.meiocompleto, 
                                    json.numero_processo, 
                                    json.nomeOrgao, 
                                    json.tipoDocumento, 
                                    json.datadisponibilizacao, 
                                    json.texto,
                                    json.destinatarioadvogados, 
                                    json.destinatarios, 
                                    json.hash, 
                                    json.link 
                                );

                })
            });
            
        }

        //Função responsavel pela criação e adição de itens na página
        function formatarHTML(cabecalho, pagina, meio, num_processo, orgao, tipo_doc, data_disponibilizacao, teor, autores, reu, cod_certidao, link){

            //Criando variavel com o HTML do novo item
            let novoHTML = `<div>
                                <strong>${cabecalho}</strong></br>
                                <strong>Página: </strong>${pagina}</br></br>
                                <strong>${meio}</strong></br>
                                <strong>Número do processo: </strong>${num_processo}</br>
                                <strong>Órgão: </strong>${orgao}</br>
                                <strong>Tipo de documento: </strong>${tipo_doc}</br>
                                <strong>Disponibilizado em: </strong>${data_disponibilizacao}</br>
                                <strong>Teor: </strong>${teor}</br>`;
            
            autores.forEach(autor => {
                
                novoHTML += `<strong>Autor: </strong>${JSON.stringify(autor)}</br>`

            });

            reu.forEach(reu => {
                
                novoHTML += `<strong>Reu: </strong>${JSON.stringify(reu)}</br>`

            });

            novoHTML += `
                            <strong>Código da certidão: </strong>${cod_certidao}</br>
                            <strong>Link: </strong>${link}
                            </div></br></br>`;

            //Adicionando novo item a página
            conteudo.innerHTML += novoHTML;           

        }

        function gerarPDF(){

            let divs = retornarConteudoComoLista()

            var doc = new jsPDF("p", "pt", "letter"); 
            doc.setFontSize(10);
  
            for(let x = 0; x < divs.length; x++){


                if(divs[x].innerText.length >  6210 ){
                    
                    let textoDividido = divideStringGrande(divs[x].innerText)
                    for(let i = 0; i < textoDividido.length; i++){

                        let textoQuebrado = doc.splitTextToSize(textoDividido[i], 500);
                        doc.text(textoQuebrado, 10, 20);

                       
                        if ((i+1) < textoDividido.length){ doc.addPage() }

                    }
                    


                }else{


                    let textoQuebrado = doc.splitTextToSize(divs[x].innerText, 500);
                    doc.text(textoQuebrado, 10, 20);
                
                }

                if ((x+1) < divs.length){ doc.addPage() }

            }


            doc.save('dados.pdf');
        }


        function retornarConteudoComoLista(){
            return conteudo.getElementsByTagName('div');
                
        }

        function divideStringGrande(textoGrande){

            let textoDividido = []
            let indiceDeInicioDaSubstring = 0
            

            for(let x = 0; x < textoGrande.length; x++){

                
                if(x+1 == textoGrande.length){

                    textoDividido.push(textoGrande.slice(indiceDeInicioDaSubstring, x))

                }else if(x%6210 == 0 && x > 1){
                    
                    textoDividido.push(textoGrande.slice(indiceDeInicioDaSubstring, x))
                    indiceDeInicioDaSubstring = x

                }
            }

            return textoDividido

        }



    </script>
</body>
</html>
